<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <title>ADADA Copyediting Helper</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 24px;
        }

        .small-hint {
            font-size: .92rem;
            color: #666;
        }

        .preview-wrap {
            position: relative;
            display: inline-block;
        }

        #pdfCanvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        #overlay {
            position: absolute;
            left: 0;
            top: 0;
            pointer-events: none;
        }

        #overlay .drw {
            position: absolute;
            white-space: nowrap;
            line-height: 1;
            color: #000;
        }

        #overlayConf,
        #overlayCr {
            background: transparent;
            text-shadow: 0 0 1px rgba(255, 255, 255, .5);
        }

        .mono {
            font-family: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mb-2">ADADA Copyediting Helper</h1>
        <p class="small-hint mb-4">原点は左下、単位はpt（1pt ≒
            0.3528mm）。プレビューは1ページ目のみ。プレビューと出力は一致するようにしていますが、保存した場合に微妙なずれが生じます。保存したPDFで最終確認をお願いします。</p>

        <div class="row g-4">
            <!-- 左：入力 -->
            <div class="col-12 col-lg-5">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">1) PDF を選択 <small class="text-muted">(必須)</small></h5>
                        <input class="form-control" type="file" id="pdfFile" accept="application/pdf" />
                        <div id="pageInfo" class="mt-2 small-hint"></div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">2) 画像（ユーザ指定可／未指定は journal.png）</h5>
                        <div class="row g-2 mb-2">
                            <div class="col-12">
                                <label class="form-label">画像ファイルを選択（任意）</label>
                                <input type="file" class="form-control" id="userImg" accept="image/*">
                                <div class="small-hint mt-1">未選択時は同階層の <code>journal.png</code> を使用します。</div>
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label">X</label>
                                <input type="number" class="form-control upd" id="imgX" value="471" step="1">
                            </div>
                            <div class="col-4">
                                <label class="form-label">Y</label>
                                <input type="number" class="form-control upd" id="imgY" value="777" step="1">
                            </div>
                            <div class="col-4">
                                <label class="form-label">幅 (pt)</label>
                                <input type="number" class="form-control upd" id="imgW" value="74" step="1" min="1">
                            </div>
                            <div class="col-12 mt-1">
                                <div class="form-check">
                                    <input class="form-check-input upd" type="checkbox" id="lockAspect" checked>
                                    <label class="form-check-label" for="lockAspect">縦横比を保持（高さは自動）</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">3) テキスト（Times で描画）</h5>
                        <div class="mb-2">
                            <label class="form-label">受付採録日</label>
                            <input type="text" class="form-control upd" id="confText"
                                value="Received February 25th, 2025 ; Accepted August 18th, 2025">
                        </div>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label">X</label>
                                <input type="number" class="form-control upd" id="confX" value="50">
                            </div>
                            <div class="col-4">
                                <label class="form-label">Y</label>
                                <input type="number" class="form-control upd" id="confY" value="780">
                            </div>
                            <div class="col-4">
                                <label class="form-label">サイズ (pt)</label>
                                <input type="number" class="form-control upd" id="confSize" value="7" min="1">
                            </div>
                        </div>
                        <hr>
                        <div class="mb-2">
                            <label class="form-label">Copyright</label>
                            <input type="text" class="form-control upd" id="crText"
                                value="This work is licensed under the Creative Commons Attribution 4.0 International License.">
                        </div>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label">X</label>
                                <input type="number" class="form-control upd" id="crX" value="50">
                            </div>
                            <div class="col-4">
                                <label class="form-label">Y</label>
                                <input type="number" class="form-control upd" id="crY" value="62">
                            </div>
                            <div class="col-4">
                                <label class="form-label">サイズ (pt)</label>
                                <input type="number" class="form-control upd" id="crSize" value="7" min="1">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">4) ページ番号（Times）</h5>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="usePageNo">
                            <label class="form-check-label" for="usePageNo">ページ番号を付与（全ページに連番で）</label>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">開始番号</label>
                                <input type="number" class="form-control" id="pageStart" value="1" min="1" step="1">
                            </div>
                            <div class="col-6">
                                <label class="form-label">文字サイズ (pt)</label>
                                <input type="number" class="form-control" id="pageSize" value="9" min="1">
                            </div>
                        </div>
                        <div class="small-hint mt-2">1ページ目は開始番号、2ページ目は開始+1 … と順に連番で付与されます。</div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" id="generateBtn">PDFを生成して保存</button>
                    <button class="btn btn-outline-info" id="shareBtn">設定を共有リンクでコピー</button>
                    <button class="btn btn-outline-secondary" id="resetBtn">入力をリセット</button>
                </div>

                <details class="mt-3">
                    <summary><strong>補足</strong></summary>
                    <div class="mono small-hint mt-2">
                        1pt ≒ 0.3528mm（例：10mm ≒ 28.35pt）<br />
                        テキストYはベースライン基準。<br />
                    </div>
                </details>
            </div>

            <!-- 右：プレビュー -->
            <div class="col-12 col-lg-7">
                <div class="card">
                    <div class="card-body" <h5 class="card-title mb-2">プレビュー（1ページ目）</h5>
                        <div id="noPreviewMessage" class="text-center py-5 text-muted">
                            <h4>PDFを選択して下さい</h4>
                        </div>
                        <div class="preview-wrap" id="previewWrap" style="display: none;">
                            <canvas id="pdfCanvas"></canvas>
                            <div id="overlay">
                                <img id="overlayImg" class="drw" alt="" />
                                <span id="overlayConf" class="drw"></span>
                                <span id="overlayCr" class="drw"></span>
                                <span id="overlayPg" class="drw"></span>
                            </div>
                        </div>
                        <div class="small-hint mt-2" id="previewHint" style="display: none;">※ プレビューは1ページ目のみ。</div>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <footer class="mt-4 text-center small text-muted">
            &copy; 2025 Tetsuaki Baba, <a href="https://github.com/TetsuakiBaba/ADADACopyeditingHelper" target="_blank"
                rel="noopener noreferrer">GitHub</a>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
        const LOGO_DEFAULT_SRC = "journal.png";
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

        const $ = id => document.getElementById(id);
        const pdfFile = $('pdfFile'), pageInfo = $('pageInfo');
        const pdfCanvas = $('pdfCanvas'), overlay = $('overlay');
        const overlayImg = $('overlayImg'), overlayConf = $('overlayConf'), overlayCr = $('overlayCr'), overlayPg = $('overlayPg');
        const userImgInput = $('userImg');
        const generateBtn = $('generateBtn'), resetBtn = $('resetBtn'), shareBtn = $('shareBtn');
        const noPreviewMessage = $('noPreviewMessage');
        const previewWrap = $('previewWrap');
        const previewHint = $('previewHint');

        const imgX = $('imgX'), imgY = $('imgY'), imgW = $('imgW'), lockAspect = $('lockAspect');
        const confText = $('confText'), confX = $('confX'), confY = $('confY'), confSize = $('confSize');
        const crText = $('crText'), crX = $('crX'), crY = $('crY'), crSize = $('crSize');

        const usePageNo = $('usePageNo'), pageStart = $('pageStart'), pageSize = $('pageSize');

        let srcPdfBytes = null;
        let firstPageSizePt = { width: 0, height: 0 };
        let scalePxPerPt = 1;
        let pngNatural = { w: 1, h: 1 };
        let userImgFile = null, userImgURL = null;
        let isPdfLoaded = false;

        function setOverlayImageSrc(src) {
            overlayImg.onload = () => { pngNatural = { w: overlayImg.naturalWidth, h: overlayImg.naturalHeight }; renderOverlay(); };
            overlayImg.src = src;
        }

        // 初期状態では画像を読み込まない
        // setOverlayImageSrc(LOGO_DEFAULT_SRC);

        // URLパラメータから設定を読み込む
        function loadSettingsFromURL() {
            const params = new URLSearchParams(window.location.search);

            if (params.has('imgX')) imgX.value = params.get('imgX');
            if (params.has('imgY')) imgY.value = params.get('imgY');
            if (params.has('imgW')) imgW.value = params.get('imgW');
            if (params.has('lockAspect')) lockAspect.checked = params.get('lockAspect') === 'true';

            if (params.has('confText')) confText.value = decodeURIComponent(params.get('confText'));
            if (params.has('confX')) confX.value = params.get('confX');
            if (params.has('confY')) confY.value = params.get('confY');
            if (params.has('confSize')) confSize.value = params.get('confSize');

            if (params.has('crText')) crText.value = decodeURIComponent(params.get('crText'));
            if (params.has('crX')) crX.value = params.get('crX');
            if (params.has('crY')) crY.value = params.get('crY');
            if (params.has('crSize')) crSize.value = params.get('crSize');

            if (params.has('usePageNo')) usePageNo.checked = params.get('usePageNo') === 'true';
            if (params.has('pageStart')) pageStart.value = params.get('pageStart');
            if (params.has('pageSize')) pageSize.value = params.get('pageSize');
        }

        // 設定をURLパラメータに変換
        function getSettingsAsURLParams() {
            const params = new URLSearchParams();

            params.set('imgX', imgX.value);
            params.set('imgY', imgY.value);
            params.set('imgW', imgW.value);
            params.set('lockAspect', lockAspect.checked);

            params.set('confText', encodeURIComponent(confText.value));
            params.set('confX', confX.value);
            params.set('confY', confY.value);
            params.set('confSize', confSize.value);

            params.set('crText', encodeURIComponent(crText.value));
            params.set('crX', crX.value);
            params.set('crY', crY.value);
            params.set('crSize', crSize.value);

            params.set('usePageNo', usePageNo.checked);
            params.set('pageStart', pageStart.value);
            params.set('pageSize', pageSize.value);

            return params.toString();
        }

        // 初期化時にURLパラメータから設定を読み込む
        loadSettingsFromURL();

        userImgInput.addEventListener('change', () => {
            userImgFile = userImgInput.files && userImgInput.files[0] ? userImgInput.files[0] : null;
            if (userImgURL) { URL.revokeObjectURL(userImgURL); userImgURL = null; }
            if (userImgFile) {
                userImgURL = URL.createObjectURL(userImgFile);
                if (isPdfLoaded) setOverlayImageSrc(userImgURL);
            } else {
                if (isPdfLoaded) setOverlayImageSrc(LOGO_DEFAULT_SRC);
            }
        });

        pdfFile.addEventListener('change', async () => {
            pageInfo.textContent = '';
            const file = pdfFile.files?.[0];
            if (!file) {
                // PDFファイルがクリアされた場合
                isPdfLoaded = false;
                srcPdfBytes = null;
                noPreviewMessage.style.display = 'block';
                previewWrap.style.display = 'none';
                previewHint.style.display = 'none';
                return;
            }

            srcPdfBytes = new Uint8Array(await file.arrayBuffer());

            try {
                const doc = await PDFLib.PDFDocument.load(srcPdfBytes);
                const page = doc.getPage(0);
                const { width, height } = page.getSize();
                firstPageSizePt = { width, height };
                pageInfo.textContent = `1ページ目サイズ: ${Math.round(width)} × ${Math.round(height)} pt`;
            } catch (e) { console.error(e); pageInfo.textContent = 'PDFの読み取りに失敗しました。'; return; }

            await renderPdfFirstPageToCanvas(srcPdfBytes, firstPageSizePt);

            // PDFが読み込まれた後に画像も読み込む
            isPdfLoaded = true;
            if (userImgFile) {
                setOverlayImageSrc(userImgURL);
            } else {
                setOverlayImageSrc(LOGO_DEFAULT_SRC);
            }

            // プレビューを表示
            noPreviewMessage.style.display = 'none';
            previewWrap.style.display = 'inline-block';
            previewHint.style.display = 'block';

            renderOverlay();
        });

        document.querySelectorAll('.upd, #usePageNo, #pageStart, #pageSize').forEach(el => {
            el.addEventListener('input', renderOverlay);
            el.addEventListener('change', renderOverlay);
        });

        generateBtn.addEventListener('click', async () => {
            if (!srcPdfBytes) { alert('PDFファイルを選択してください。'); return; }

            const iX = +imgX.value || 0;
            const iY = +imgY.value || 0;
            const iW = Math.max(1, +imgW.value || 1);

            const t1 = (confText.value ?? '');
            const t1x = +confX.value || 0;
            const t1y = +confY.value || 0;
            const t1s = Math.max(1, +confSize.value || 1);

            const t2 = (crText.value ?? '');
            const t2x = +crX.value || 0;
            const t2y = +crY.value || 0;
            const t2s = Math.max(1, +crSize.value || 1);

            const addPageNo = !!usePageNo.checked;
            const pStart = Math.floor(+pageStart.value || 1);
            const pSize = Math.max(1, +pageSize.value || 9);
            const bottomMargin = 25;

            try {
                const pdfDoc = await PDFLib.PDFDocument.load(srcPdfBytes);
                const fontTimes = await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRoman);

                const imgBytes = await getImageBytes(userImgFile ? userImgFile : LOGO_DEFAULT_SRC);
                let imgEmbed, imgDims;
                try { imgEmbed = await pdfDoc.embedPng(imgBytes); imgDims = imgEmbed.scale(1); }
                catch { imgEmbed = await pdfDoc.embedJpg(imgBytes); imgDims = imgEmbed.scale(1); }

                const pageCount = pdfDoc.getPageCount();

                // 1ページ目：画像＋テキスト
                {
                    const page = pdfDoc.getPage(0);
                    const drawW = iW;
                    const drawH = (imgDims.height / imgDims.width) * drawW;
                    page.drawImage(imgEmbed, { x: iX, y: iY, width: drawW, height: drawH });
                    if (t1.trim()) page.drawText(t1, { x: t1x, y: t1y, size: t1s, font: fontTimes, color: PDFLib.rgb(0, 0, 0) });
                    if (t2.trim()) page.drawText(t2, { x: t2x, y: t2y, size: t2s, font: fontTimes, color: PDFLib.rgb(0, 0, 0) });
                }

                // ページ番号：開始番号から全ページに連番で付与
                if (addPageNo) {
                    for (let i = 0; i < pageCount; i++) {
                        const num = pStart + i;
                        const page = pdfDoc.getPage(i);
                        const { width: pw } = page.getSize();
                        const text = String(num);
                        const textWidth = fontTimes.widthOfTextAtSize(text, pSize);
                        const x = (pw - textWidth) / 2;
                        const y = bottomMargin;
                        page.drawText(text, { x, y, size: pSize, font: fontTimes, color: PDFLib.rgb(0, 0, 0) });
                    }
                }

                const newPdf = await pdfDoc.save();
                const blob = new Blob([newPdf], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const base = (pdfFile.files[0]?.name || 'output.pdf').replace(/\.pdf$/i, '');
                a.href = url; a.download = `${base}_with_logo_and_text.pdf`;
                document.body.appendChild(a); a.click(); a.remove();
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                alert('PDF生成に失敗しました。コンソールをご確認ください。');
            }
        });

        resetBtn.addEventListener('click', () => {
            userImgInput.value = "";
            if (userImgURL) { URL.revokeObjectURL(userImgURL); userImgURL = null; }
            userImgFile = null;
            isPdfLoaded = false;
            srcPdfBytes = null;

            // プレビューをリセット
            noPreviewMessage.style.display = 'block';
            previewWrap.style.display = 'none';
            previewHint.style.display = 'none';
            pageInfo.textContent = '';

            imgX.value = 471; imgY.value = 777; imgW.value = 74; lockAspect.checked = true;

            confText.value = "Received February 25th, 2025 ; Accepted August 18th, 2025";
            confX.value = 50; confY.value = 780; confSize.value = 7;

            crText.value = "This article is licensed under a Creative Commons [Attribution 4.0 International] License.";
            crX.value = 50; crY.value = 62; crSize.value = 7;

            usePageNo.checked = false;
            pageStart.value = 1; pageSize.value = 9;
        });

        shareBtn.addEventListener('click', async () => {
            const params = getSettingsAsURLParams();
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = params ? `${baseUrl}?${params}` : baseUrl;

            try {
                await navigator.clipboard.writeText(shareUrl);
                // ボタンのテキストを一時的に変更してフィードバック
                const originalText = shareBtn.textContent;
                shareBtn.textContent = 'コピー完了！';
                shareBtn.classList.remove('btn-outline-info');
                shareBtn.classList.add('btn-success');

                setTimeout(() => {
                    shareBtn.textContent = originalText;
                    shareBtn.classList.remove('btn-success');
                    shareBtn.classList.add('btn-outline-info');
                }, 2000);
            } catch (err) {
                console.error('クリップボードへのコピーに失敗:', err);
                // フォールバック: プロンプトでURLを表示
                prompt('以下のURLをコピーしてください:', shareUrl);
            }
        });

        async function renderPdfFirstPageToCanvas(bytes, pageSizePt) {
            const loadingTask = pdfjsLib.getDocument({ data: bytes.slice() });
            const pdf = await loadingTask.promise;
            const page = await pdf.getPage(1);

            const maxW = Math.min(900, document.querySelector('.col-lg-7').clientWidth - 48 || 900);
            const scale = Math.min(maxW / pageSizePt.width, 1.8);
            const viewport = page.getViewport({ scale });

            const ctx = pdfCanvas.getContext('2d');
            pdfCanvas.width = Math.floor(viewport.width);
            pdfCanvas.height = Math.floor(viewport.height);

            overlay.style.width = pdfCanvas.width + 'px';
            overlay.style.height = pdfCanvas.height + 'px';

            scalePxPerPt = viewport.width / pageSizePt.width;
            await page.render({ canvasContext: ctx, viewport }).promise;
        }

        function renderOverlay() {
            if (!isPdfLoaded || !firstPageSizePt.width || !pdfCanvas.width) return;
            const Hpx = pdfCanvas.height;
            const s = scalePxPerPt;

            const iX = +imgX.value || 0;
            const iY = +imgY.value || 0;
            const iWpt = Math.max(1, +imgW.value || 1);
            const iWpx = iWpt * s;

            const aspect = (pngNatural.w > 0) ? (pngNatural.h / pngNatural.w) : 1;
            const iHpx = iWpx * aspect;

            overlayImg.style.width = iWpx + 'px';
            overlayImg.style.height = iHpx + 'px';
            overlayImg.style.left = (iX * s) + 'px';
            overlayImg.style.top = (Hpx - (iY * s) - iHpx) + 'px';

            const t1 = (confText.value ?? '');
            const t1x = +confX.value || 0;
            const t1y = +confY.value || 0;
            const t1sPt = Math.max(1, +confSize.value || 1);
            const t1sPx = t1sPt * s;

            overlayConf.textContent = t1;
            overlayConf.style.fontFamily = `"Times New Roman", Times, serif`;
            overlayConf.style.fontSize = `${t1sPx}px`;
            overlayConf.style.left = (t1x * s) + 'px';
            overlayConf.style.top = (Hpx - (t1y * s) - t1sPx) + 'px';

            const t2 = (crText.value ?? '');
            const t2x = +crX.value || 0;
            const t2y = +crY.value || 0;
            const t2sPt = Math.max(1, +crSize.value || 1);
            const t2sPx = t2sPt * s;

            overlayCr.textContent = t2;
            overlayCr.style.fontFamily = `"Times New Roman", Times, serif`;
            overlayCr.style.fontSize = `${t2sPx}px`;
            overlayCr.style.left = (t2x * s) + 'px';
            overlayCr.style.top = (Hpx - (t2y * s) - t2sPx) + 'px';

            // プレビューは1ページ目の開始番号のみ
            const addPageNo = !!usePageNo.checked;
            const pStart = Math.floor(+pageStart.value || 1);
            const pSize = Math.max(1, +pageSize.value || 9);
            const pSizePx = pSize * s;

            if (addPageNo) {
                overlayPg.style.display = 'block';
                overlayPg.textContent = String(pStart);
                overlayPg.style.fontFamily = `"Times New Roman", Times, serif`;
                overlayPg.style.fontSize = `${pSizePx}px`;
                overlayPg.style.left = (pdfCanvas.width / 2) + 'px';
                overlayPg.style.top = (Hpx - (20 * s) - pSizePx) + 'px';
                overlayPg.style.transform = 'translateX(-50%)';
            } else {
                overlayPg.style.display = 'none';
            }
        }

        async function getImageBytes(source) {
            if (source && typeof source === 'object' && 'arrayBuffer' in source) {
                const ab = await source.arrayBuffer(); return new Uint8Array(ab);
            }
            if (typeof source === 'string' && /^(data:|https?:)/i.test(source)) {
                const res = await fetch(source); const ab = await res.arrayBuffer(); return new Uint8Array(ab);
            }
            const res = await fetch(source); const ab = await res.arrayBuffer(); return new Uint8Array(ab);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>